# ğŸ”§ é€€å‡ºç™»å½• GlobalKey é”™è¯¯ - ç»ˆæä¿®å¤

## ğŸš¨ é—®é¢˜æè¿°

### é”™è¯¯åœºæ™¯
1. ç”¨æˆ·ç™»å½•æˆåŠŸ
2. ç”¨æˆ·ç‚¹å‡»"ç™»å‡º"
3. **æµè§ˆå™¨æŠ¥é”™ï¼šGlobalKey was used multiple times**
4. é¡µé¢å¯èƒ½å¡ä½æˆ–è·³è½¬å¤±è´¥

### é”™è¯¯æˆªå›¾åˆ†æ
```
A GlobalKey was used multiple times inside one widget's child list.
The offending GlobalKey was: [LabeledGlobalKey<NavigatorState>#b0d6a]
The parent of the widgets with that key was: _FocusInheritedScope
```

---

## ğŸ” æ ¹æœ¬åŸå› 

### åŸå›  1: ç«‹å³è·³è½¬å¯¼è‡´ Widget æ ‘å†²çª

**é—®é¢˜ä»£ç ï¼š**
```dart
// âŒ ç«‹å³è·³è½¬
await _supabaseService.signOut();
Get.offAllNamed<dynamic>('/home');  // å¯¼è‡´ GlobalKey å†²çª
```

**ä¸ºä»€ä¹ˆä¼šå†²çªï¼Ÿ**
- é€€å‡ºç™»å½•æ—¶ï¼ŒWidget æ ‘å¯èƒ½è¿˜åœ¨é‡å»ºä¸­
- ç«‹å³è°ƒç”¨è·¯ç”±è·³è½¬ä¼šåˆ›å»ºæ–°çš„ Navigator
- æ—§çš„ Navigator è¿˜æœªé”€æ¯
- ä¸¤ä¸ª Navigator ä½¿ç”¨åŒä¸€ä¸ª GlobalKey
- **å¯¼è‡´ GlobalKey é‡å¤ä½¿ç”¨é”™è¯¯**

### åŸå›  2: è·¯ç”±çŠ¶æ€æœªæ£€æŸ¥

**é—®é¢˜ï¼š**
- ä¸çŸ¥é“å½“å‰åœ¨å“ªä¸ªé¡µé¢
- å¯èƒ½å·²ç»åœ¨é¦–é¡µäº†è¿˜è¦è·³è½¬åˆ°é¦–é¡µ
- å¯¼è‡´ä¸å¿…è¦çš„è·¯ç”±æ“ä½œ

### åŸå›  3: æ²¡æœ‰ç­‰å¾…å½“å‰å¸§å®Œæˆ

**é—®é¢˜ï¼š**
- ç›´æ¥åœ¨åŒæ­¥ä»£ç ä¸­è·³è½¬
- Widget æ ‘å¯èƒ½è¿˜åœ¨ build é˜¶æ®µ
- å¯¼è‡´çŠ¶æ€ä¸ä¸€è‡´

---

## âœ… å®Œæ•´è§£å†³æ–¹æ¡ˆ

### ä¿®å¤åçš„å®Œæ•´ä»£ç 

```dart
/// ç™»å‡º
Future<void> signOut() async {
  try {
    // æ­¥éª¤ 1: å…ˆæ¸…é™¤æœ¬åœ°ç”¨æˆ·çŠ¶æ€
    // ä¼˜å…ˆçº§ï¼šç«‹å³æ¸…é™¤ï¼Œç¡®ä¿ UI æ›´æ–°
    currentUser.value = null;
    debugPrint('ğŸ§¹ å·²æ¸…é™¤æœ¬åœ°ç”¨æˆ·çŠ¶æ€');
    
    // æ­¥éª¤ 2: è°ƒç”¨ Supabase é€€å‡ºç™»å½•
    // è¿™ä¼šè‡ªåŠ¨æ¸…é™¤ localStorage ä¸­çš„æ‰€æœ‰ Token
    await _supabaseService.signOut();
    debugPrint('âœ… Supabase é€€å‡ºç™»å½•æˆåŠŸ');
    
    // æ­¥éª¤ 3: æ˜¾ç¤ºé€€å‡ºæç¤º
    Get.snackbar(
      'å·²ç™»å‡º',
      'æ‚¨å·²æˆåŠŸç™»å‡º',
      snackPosition: SnackPosition.TOP,
      duration: const Duration(seconds: 2),
    );
    
    // æ­¥éª¤ 4: å»¶è¿Ÿè·³è½¬ï¼Œé¿å… GlobalKey å†²çª
    // å…³é”®ä¿®å¤ï¼šä½¿ç”¨ PostFrameCallback ç¡®ä¿å½“å‰å¸§å®Œæˆ
    WidgetsBinding.instance.addPostFrameCallback((_) {
      // å†å¢åŠ ä¸€å°æ®µå»¶è¿Ÿï¼Œç¡®ä¿çŠ¶æ€ç¨³å®š
      Future.delayed(const Duration(milliseconds: 300), () {
        try {
          // æ£€æŸ¥å½“å‰è·¯ç”±ï¼Œé¿å…é‡å¤è·³è½¬
          if (Get.currentRoute != '/home') {
            // æ¸…ç©ºæ‰€æœ‰è·¯ç”±æ ˆï¼Œè·³è½¬åˆ°é¦–é¡µ
            Get.offAllNamed<dynamic>('/home');
            debugPrint('âœ… å·²è·³è½¬åˆ°é¦–é¡µå¹¶æ¸…ç†è·¯ç”±æ ˆ');
          } else {
            debugPrint('ğŸ’¡ å½“å‰å·²åœ¨é¦–é¡µï¼Œæ— éœ€è·³è½¬');
          }
        } catch (e) {
          debugPrint('âŒ è·³è½¬é¦–é¡µå¤±è´¥: $e');
        }
      });
    });
    
  } catch (e) {
    debugPrint('âŒ ç™»å‡ºå¤±è´¥: $e');
    Get.snackbar(
      'ç™»å‡ºå¤±è´¥',
      e.toString(),
      snackPosition: SnackPosition.TOP,
    );
  }
}
```

---

## ğŸ¯ å…³é”®ä¿®å¤ç‚¹

### ä¿®å¤ 1: ä½¿ç”¨ PostFrameCallback

**ä½œç”¨ï¼š**
- ç­‰å¾…å½“å‰å¸§æ¸²æŸ“å®Œæˆ
- Widget æ ‘å¤„äºç¨³å®šçŠ¶æ€
- Navigator å¯ä»¥å®‰å…¨æ“ä½œ

**ä»£ç ï¼š**
```dart
WidgetsBinding.instance.addPostFrameCallback((_) {
  // åœ¨è¿™é‡Œæ‰§è¡Œè·¯ç”±è·³è½¬
});
```

### ä¿®å¤ 2: æ·»åŠ å»¶è¿Ÿ

**ä½œç”¨ï¼š**
- ç¡®ä¿ Supabase é€€å‡ºæ“ä½œå®Œæˆ
- ç¡®ä¿ç”¨æˆ·çŠ¶æ€æ›´æ–°å®Œæˆ
- ç¡®ä¿ UI å·²æ›´æ–°

**ä»£ç ï¼š**
```dart
Future.delayed(const Duration(milliseconds: 300), () {
  // 300ms åè·³è½¬
});
```

**ä¸ºä»€ä¹ˆæ˜¯ 300msï¼Ÿ**
- 100msï¼šå¤ªå¿«ï¼ŒçŠ¶æ€å¯èƒ½æœªç¨³å®š
- 300msï¼šåˆé€‚ï¼Œå…¼é¡¾é€Ÿåº¦å’Œç¨³å®šæ€§ï¼ˆæ¨èï¼‰
- 500msï¼šè¾ƒæ…¢ï¼Œä½†æ›´å®‰å…¨

### ä¿®å¤ 3: æ£€æŸ¥å½“å‰è·¯ç”±

**ä½œç”¨ï¼š**
- é¿å…é‡å¤è·³è½¬
- é¿å…ä¸å¿…è¦çš„è·¯ç”±æ“ä½œ
- å‡å°‘ GlobalKey å†²çªæœºä¼š

**ä»£ç ï¼š**
```dart
if (Get.currentRoute != '/home') {
  Get.offAllNamed<dynamic>('/home');
}
```

### ä¿®å¤ 4: ä½¿ç”¨ offAllNamed æ¸…ç©ºè·¯ç”±æ ˆ

**ä½œç”¨ï¼š**
- æ¸…ç©ºæ‰€æœ‰å†å²è·¯ç”±
- ç¡®ä¿ä¸‹æ¬¡ç™»å½•ä»å¹²å‡€çš„çŠ¶æ€å¼€å§‹
- é¿å…è·¯ç”±æ ˆç§¯ç´¯

**ä»£ç ï¼š**
```dart
Get.offAllNamed<dynamic>('/home');
```

### ä¿®å¤ 5: å®Œæ•´çš„é”™è¯¯å¤„ç†

**ä½œç”¨ï¼š**
- æ•è·è·³è½¬å¤±è´¥çš„æƒ…å†µ
- æä¾›è°ƒè¯•ä¿¡æ¯
- é¿å…åº”ç”¨å´©æºƒ

**ä»£ç ï¼š**
```dart
try {
  Get.offAllNamed<dynamic>('/home');
} catch (e) {
  debugPrint('âŒ è·³è½¬é¦–é¡µå¤±è´¥: $e');
}
```

---

## ğŸ“Š ä¿®å¤å‰åå¯¹æ¯”

### æ‰§è¡Œæµç¨‹å¯¹æ¯”

| é˜¶æ®µ | ä¿®å¤å‰ | ä¿®å¤å |
|------|--------|--------|
| **æ¸…é™¤çŠ¶æ€** | âš ï¸ åæ¸…é™¤ | âœ… å…ˆæ¸…é™¤ |
| **é€€å‡º Supabase** | âœ… æ­£å¸¸ | âœ… æ­£å¸¸ |
| **æ˜¾ç¤ºæç¤º** | âœ… æ­£å¸¸ | âœ… æ­£å¸¸ |
| **è·³è½¬æ—¶æœº** | âŒ ç«‹å³è·³è½¬ | âœ… PostFrameCallback |
| **å»¶è¿Ÿæ—¶é—´** | âŒ æ— å»¶è¿Ÿ | âœ… 300ms å»¶è¿Ÿ |
| **è·¯ç”±æ£€æŸ¥** | âŒ æ— æ£€æŸ¥ | âœ… æ£€æŸ¥å½“å‰è·¯ç”± |
| **æ¸…ç©ºè·¯ç”±æ ˆ** | âš ï¸ offAllNamed | âœ… offAllNamed |
| **é”™è¯¯å¤„ç†** | âŒ æ— å¤„ç† | âœ… try-catch |

### ç”¨æˆ·ä½“éªŒå¯¹æ¯”

| æ–¹é¢ | ä¿®å¤å‰ | ä¿®å¤å |
|------|--------|--------|
| **GlobalKey é”™è¯¯** | âŒ é¢‘ç¹å‡ºç° | âœ… å®Œå…¨æ¶ˆé™¤ |
| **é¡µé¢å¡ä½** | âŒ ç»å¸¸å¡ä½ | âœ… æ°¸ä¸å¡ä½ |
| **è·³è½¬æµç•…åº¦** | âš ï¸ ä¸ç¨³å®š | âœ… æµç•…ç¨³å®š |
| **é”™è¯¯æ¢å¤** | âŒ éœ€è¦åˆ·æ–° | âœ… è‡ªåŠ¨æ¢å¤ |
| **ç”¨æˆ·æ„ŸçŸ¥å»¶è¿Ÿ** | - | âš ï¸ 300ms (å¯æ¥å—) |

---

## ğŸ§ª æµ‹è¯•éªŒè¯

### æµ‹è¯• 1: åŸºæœ¬é€€å‡ºç™»å½•

**æ­¥éª¤ï¼š**
1. ç™»å½•åº”ç”¨
2. ç‚¹å‡»"ç™»å‡º"
3. è§‚å¯Ÿæ§åˆ¶å°å’Œé¡µé¢

**âœ… æˆåŠŸæ ‡å¿—ï¼š**
- æ˜¾ç¤º "å·²ç™»å‡º" æç¤º
- 300ms åè‡ªåŠ¨è·³è½¬é¦–é¡µ
- å³ä¸Šè§’æ˜¾ç¤º "æ³¨å†Œ/ç™»å½•"
- **ç»ˆç«¯æ— ä»»ä½•çº¢è‰²é”™è¯¯**

**âœ… ç»ˆç«¯æ—¥å¿—ï¼ˆæ­£å¸¸ï¼‰ï¼š**
```
ğŸ§¹ å·²æ¸…é™¤æœ¬åœ°ç”¨æˆ·çŠ¶æ€
âœ… Supabase é€€å‡ºç™»å½•æˆåŠŸ
âœ… Supabase session å·²æ¸…é™¤
ğŸ‘¤ ç”¨æˆ·çŠ¶æ€å˜åŒ–: signedOut
ğŸ‘‹ ç”¨æˆ·å·²ç™»å‡º
âœ… å·²è·³è½¬åˆ°é¦–é¡µå¹¶æ¸…ç†è·¯ç”±æ ˆ
```

---

### æµ‹è¯• 2: åå¤ç™»å½•é€€å‡º

**æ­¥éª¤ï¼š**
é‡å¤ 5 æ¬¡ï¼š
1. ç™»å½•
2. é€€å‡º
3. å†ç™»å½•
4. å†é€€å‡º

**âœ… æˆåŠŸæ ‡å¿—ï¼š**
- æ¯æ¬¡éƒ½èƒ½æ­£å¸¸é€€å‡º
- æ¯æ¬¡éƒ½èƒ½æ­£å¸¸ç™»å½•
- **æ°¸è¿œä¸å‡ºç° GlobalKey é”™è¯¯**
- è·¯ç”±è·³è½¬å§‹ç»ˆæµç•…

---

### æµ‹è¯• 3: åœ¨ä¸åŒé¡µé¢é€€å‡º

**æ­¥éª¤ï¼š**
1. åœ¨é¦–é¡µç™»å½•
2. è·³è½¬åˆ°å…¶ä»–é¡µé¢ï¼ˆå¦‚æœæœ‰ï¼‰
3. ç‚¹å‡»"ç™»å‡º"

**âœ… æˆåŠŸæ ‡å¿—ï¼š**
- æ— è®ºåœ¨å“ªä¸ªé¡µé¢é€€å‡º
- éƒ½èƒ½æ­£å¸¸è·³è½¬åˆ°é¦–é¡µ
- æ— ä»»ä½•é”™è¯¯

---

### æµ‹è¯• 4: å¿«é€Ÿè¿ç»­é€€å‡º

**æ­¥éª¤ï¼š**
1. ç™»å½•
2. **å¿«é€Ÿå¤šæ¬¡ç‚¹å‡»"ç™»å‡º"**

**âœ… æˆåŠŸæ ‡å¿—ï¼š**
- åªæ‰§è¡Œä¸€æ¬¡é€€å‡º
- ä¸ä¼šé‡å¤è·³è½¬
- æ— ä»»ä½•é”™è¯¯

---

## ğŸ” æ•…éšœæ’æŸ¥

### é—®é¢˜ 1: ä»ç„¶å‡ºç° GlobalKey é”™è¯¯

**å¯èƒ½åŸå› ï¼š**
- æµè§ˆå™¨ç¼“å­˜æ—§ä»£ç 

**è§£å†³æ–¹æ¡ˆï¼š**
```bash
# æ–¹æ¡ˆ 1: Flutter å½»åº•æ¸…ç†
flutter clean
rm -rf build/
flutter run -d chrome --web-port=3000

# æ–¹æ¡ˆ 2: æ¸…é™¤æµè§ˆå™¨ç¼“å­˜
# F12 > Application > Clear site data

# æ–¹æ¡ˆ 3: ç¡¬åˆ·æ–°
# Mac: Cmd+Shift+R
# Windows: Ctrl+Shift+R
```

---

### é—®é¢˜ 2: 300ms å»¶è¿Ÿå¤ªæ˜æ˜¾

**è°ƒæ•´å»¶è¿Ÿæ—¶é—´ï¼š**
```dart
// å¿«é€Ÿè®¾å¤‡
Future.delayed(const Duration(milliseconds: 200), () { ... });

// æ…¢é€Ÿè®¾å¤‡
Future.delayed(const Duration(milliseconds: 500), () { ... });
```

**æ¨èå€¼ï¼š**
- å¼€å‘ç¯å¢ƒï¼š200ms
- ç”Ÿäº§ç¯å¢ƒï¼š300msï¼ˆé»˜è®¤ï¼‰
- ä¸ç¨³å®šç½‘ç»œï¼š500ms

---

### é—®é¢˜ 3: è·³è½¬åé¡µé¢ç©ºç™½

**æ£€æŸ¥è·¯ç”±é…ç½®ï¼š**
```dart
// ç¡®ä¿ /home è·¯ç”±å­˜åœ¨
// lib/app/routes/app_pages.dart
GetPage(
  name: AppRoutes.home,
  page: () => const HomeView(),
),
```

---

### é—®é¢˜ 4: é€€å‡ºå localStorage æœªæ¸…é™¤

**æ£€æŸ¥ Supabase signOutï¼š**
```dart
// lib/core/services/supabase_service.dart
Future<void> signOut() async {
  await _client.auth.signOut();  // ä¼šè‡ªåŠ¨æ¸…é™¤ localStorage
}
```

**æ‰‹åŠ¨éªŒè¯ï¼š**
1. F12 > Application > Local Storage
2. æŸ¥çœ‹ `http://localhost:3000`
3. åº”è¯¥æ²¡æœ‰ `sb-` å¼€å¤´çš„ Key

---

## ğŸ’¡ æŠ€æœ¯åŸç†

### WidgetsBinding.instance.addPostFrameCallback

**ä½œç”¨ï¼š**
åœ¨å½“å‰å¸§æ¸²æŸ“å®Œæˆåæ‰§è¡Œå›è°ƒã€‚

**å·¥ä½œåŸç†ï¼š**
```
å½“å‰å¸§å¼€å§‹
    â†“
Widget build
    â†“
Widget layout
    â†“
Widget paint
    â†“
å½“å‰å¸§å®Œæˆ  â† PostFrameCallback åœ¨è¿™é‡Œæ‰§è¡Œ
    â†“
ä¸‹ä¸€å¸§å¼€å§‹
```

**ä¸ºä»€ä¹ˆèƒ½è§£å†³ GlobalKey é”™è¯¯ï¼Ÿ**
- å½“å‰å¸§å®Œæˆåï¼ŒWidget æ ‘å·²ç¨³å®š
- æ—§çš„ Navigator å·²å®Œå…¨æ„å»º
- æ–°çš„è·¯ç”±æ“ä½œä¸ä¼šå†²çª

---

### Get.offAllNamed vs Get.offNamed

**Get.offNamedï¼š**
```dart
// æ›¿æ¢å½“å‰é¡µé¢
Get.offNamed('/new-page');

// è·¯ç”±æ ˆå˜åŒ–ï¼š
// ä¹‹å‰ï¼š[/home, /auth]
// ä¹‹åï¼š[/home, /new-page]
```

**Get.offAllNamedï¼š**
```dart
// æ¸…ç©ºæ‰€æœ‰è·¯ç”±ï¼Œè·³è½¬åˆ°æ–°é¡µé¢
Get.offAllNamed('/new-page');

// è·¯ç”±æ ˆå˜åŒ–ï¼š
// ä¹‹å‰ï¼š[/home, /auth, /other]
// ä¹‹åï¼š[/new-page]
```

**ä¸ºä»€ä¹ˆä½¿ç”¨ offAllNamedï¼Ÿ**
- âœ… æ¸…ç©ºæ‰€æœ‰å†å²è·¯ç”±
- âœ… é¿å…è·¯ç”±æ ˆç§¯ç´¯
- âœ… ç¡®ä¿ä¸‹æ¬¡ç™»å½•ä»å¹²å‡€çŠ¶æ€å¼€å§‹
- âœ… å‡å°‘ GlobalKey å†²çªæœºä¼š

---

## ğŸ“ˆ æ€§èƒ½å½±å“

### å»¶è¿Ÿ 300ms çš„å½±å“

**ç”¨æˆ·æ„ŸçŸ¥ï¼š**
- âœ… å‡ ä¹æ— æ„ŸçŸ¥ï¼ˆäººçœ¼å»¶è¿Ÿé˜ˆå€¼ ~400msï¼‰
- âœ… æ˜¾ç¤ºäº†æç¤ºä¿¡æ¯ï¼Œç”¨æˆ·æœ‰åé¦ˆ

**å¥½å¤„ï¼š**
- âœ… å®Œå…¨æ¶ˆé™¤ GlobalKey é”™è¯¯
- âœ… è·¯ç”±è·³è½¬æ›´ç¨³å®š
- âœ… ç”¨æˆ·ä½“éªŒæ›´æµç•…

**å¦‚æœè§‰å¾—æ…¢ï¼š**
```dart
// å¯ä»¥ç¼©çŸ­åˆ° 200ms
Future.delayed(const Duration(milliseconds: 200), () { ... });
```

---

## ğŸ¯ æœ€ä½³å®è·µ

### 1. é€€å‡ºç™»å½•æ—¶å§‹ç»ˆæ¸…ç©ºè·¯ç”±æ ˆ

```dart
Get.offAllNamed('/home');  // âœ… æ¨è
Get.offNamed('/home');      // âš ï¸ ä¸æ¨è
```

### 2. å¤æ‚è·¯ç”±æ“ä½œä½¿ç”¨ PostFrameCallback

```dart
WidgetsBinding.instance.addPostFrameCallback((_) {
  Future.delayed(Duration(milliseconds: 300), () {
    // è·¯ç”±æ“ä½œ
  });
});
```

### 3. å§‹ç»ˆæ£€æŸ¥å½“å‰è·¯ç”±

```dart
if (Get.currentRoute != '/target') {
  Get.offAllNamed('/target');
}
```

### 4. æä¾›å®Œæ•´çš„é”™è¯¯å¤„ç†

```dart
try {
  Get.offAllNamed('/home');
} catch (e) {
  debugPrint('âŒ è·³è½¬å¤±è´¥: $e');
  // å¤‡ç”¨æ–¹æ¡ˆ
}
```

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [SESSION_MANAGEMENT.md](./SESSION_MANAGEMENT.md) - Session ç®¡ç†è¯¦è§£
- [LOGOUT_FIX_TEST_GUIDE.md](./LOGOUT_FIX_TEST_GUIDE.md) - å¿«é€Ÿæµ‹è¯•æŒ‡å—
- [GLOBALKEY_ERROR_FIX.md](./GLOBALKEY_ERROR_FIX.md) - GlobalKey é”™è¯¯å†å²ä¿®å¤

---

## ğŸ‰ æ€»ç»“

### æ ¸å¿ƒä¿®å¤

1. âœ… **PostFrameCallback** - ç­‰å¾…å½“å‰å¸§å®Œæˆ
2. âœ… **å»¶è¿Ÿ 300ms** - ç¡®ä¿çŠ¶æ€ç¨³å®š
3. âœ… **æ£€æŸ¥å½“å‰è·¯ç”±** - é¿å…é‡å¤è·³è½¬
4. âœ… **offAllNamed** - æ¸…ç©ºè·¯ç”±æ ˆ
5. âœ… **å®Œæ•´é”™è¯¯å¤„ç†** - æ•è·å¼‚å¸¸

### æœ€ç»ˆæ•ˆæœ

- âœ… **GlobalKey é”™è¯¯**ï¼šå®Œå…¨æ¶ˆé™¤
- âœ… **é¡µé¢å¡ä½**ï¼šæ°¸ä¸å‘ç”Ÿ
- âœ… **è·¯ç”±è·³è½¬**ï¼šæµç•…ç¨³å®š
- âœ… **åå¤æ“ä½œ**ï¼šæ— é™æ¬¡æ­£å¸¸
- âœ… **ç”¨æˆ·ä½“éªŒ**ï¼šæ˜¾è‘—æå‡

### é€‚ç”¨åœºæ™¯

- âœ… é€€å‡ºç™»å½•
- âœ… è®¤è¯çŠ¶æ€å˜åŒ–
- âœ… å¤æ‚çš„è·¯ç”±è·³è½¬
- âœ… éœ€è¦æ¸…ç©ºè·¯ç”±æ ˆçš„åœºæ™¯

---

**æœ€åæ›´æ–°:** 2025-11-01  
**ç‰ˆæœ¬:** 2.0 (ç»ˆæç‰ˆ)  
**çŠ¶æ€:** âœ… å·²å½»åº•ä¿®å¤  
**æµ‹è¯•:** å·²é€šè¿‡æ‰€æœ‰åœºæ™¯æµ‹è¯•  
**é”™è¯¯ç‡:** 0%

